{% comment %}
  Simple Savings Display Block
  Shows savings text from product or variant metafields
{% endcomment %}

{% assign v = product.selected_or_first_available_variant %}
{% assign product_text = product.metafields.custom.quantity_discount_text %}

<div id="savings-display-{{ section.id }}" class="savings-display-block" 
     data-section-id="{{ section.id }}"
     style="{% if product_text != blank or (v and v.metafields.custom.variant_only_discount_text != blank) %}display: block;{% else %}display: none;{% endif %}">
  
  <div class="savings-display-content" style="
    display: flex;
    align-items: center;
    gap: 8px;
    background: {{ block.settings.background_color | default: '#e8f5e8' }};
    border: 1px solid {{ block.settings.border_color | default: '#28a745' }};
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    margin: 8px 0;
  ">
    
    <!-- Tag Icon -->
    <div style="
      background: {{ block.settings.icon_background_color | default: '#28a745' }};
      border-radius: 3px;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      min-height: 20px;
    ">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="white">
        <path d="M5.5 7A1.5 1.5 0 0 1 4 5.5A1.5 1.5 0 0 1 5.5 4A1.5 1.5 0 0 1 7 5.5A1.5 1.5 0 0 1 5.5 7M21.41 11.58L12.41 2.58C12.05 2.22 11.55 2 11 2H4C2.9 2 2 2.9 2 4V11C2 11.55 2.22 12.05 2.59 12.42L11.58 21.41C11.95 21.78 12.45 22 13 22S14.05 21.78 14.41 21.41L21.41 14.41C21.78 14.05 22 13.55 22 13S21.78 11.95 21.41 11.58Z"/>
      </svg>
    </div>

    <!-- Text Content -->
    <div class="savings-display-text">
      <strong style="color: {{ block.settings.text_color | default: '#333' }}; font-weight: 600;">{{ block.settings.label_text | default: 'Bulk Savings' }}</strong><br>
      <span id="discount-text-{{ section.id }}" 
            data-product-text="{{ product_text }}" 
            style="color: {{ block.settings.discount_text_color | default: '#666' }}; font-size: 12px;">
        {% if v and v.metafields.custom.variant_only_discount_text != blank %}
          {{ v.metafields.custom.variant_only_discount_text }}
        {% elsif product_text != blank %}
          {{ product_text }}
        {% endif %}
      </span>
    </div>
  </div>
</div>

<script>
(function() {
  var SECTION_ID = "{{ section.id }}";
  var container = document.getElementById("savings-display-" + SECTION_ID);
  var discountText = document.getElementById("discount-text-" + SECTION_ID);
  
  if (!container || !discountText) return;

  var productText = discountText.getAttribute('data-product-text') || '';

  // Map variant IDs to their discount text
  var variantText = {
    {% for variant in product.variants %}
      "{{ variant.id }}": {{ variant.metafields.custom.variant_only_discount_text | default: '' | json }},
    {% endfor %}
  };

  // Get current variant ID
  function getCurrentVariantId() {
    var params = new URLSearchParams(location.search);
    var fromUrl = params.get('variant');
    if (fromUrl) return fromUrl;

    var select = document.querySelector('select[name="id"]');
    if (select && select.value) return select.value;

    var radio = document.querySelector('input[name="id"]:checked');
    if (radio && radio.value) return radio.value;

    var hidden = document.querySelector('input[type="hidden"][name="id"]');
    if (hidden && hidden.value) return hidden.value;

    return "{{ v.id }}";
  }

  // Update display
  function updateDisplay(variantId) {
    var text = variantText[String(variantId)] || productText;
    
    if (text && text.trim()) {
      discountText.textContent = text;
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }

  // Listen for variant changes
  document.addEventListener('variant:change', function(e){
    var id = e?.detail?.variant?.id;
    if (id) updateDisplay(id);
  });

  document.addEventListener('change', function(e){
    if (e.target && e.target.name === 'id') {
      updateDisplay(getCurrentVariantId());
    }
  });

  // Initial display
  updateDisplay(getCurrentVariantId());
})();
</script>

{% schema %}
{
  "name": "Savings Display",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "Simple display for bulk savings messages. Reads from 'quantity_discount_text' (product) or 'variant_only_discount_text' (variant) metafields."
    },
    {
      "type": "text",
      "id": "label_text",
      "label": "Label Text",
      "default": "Bulk Savings",
      "info": "Text shown before the discount message"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#e8f5e8"
    },
    {
      "type": "color",
      "id": "border_color", 
      "label": "Border Color",
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "icon_background_color",
      "label": "Icon Background Color", 
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "discount_text_color",
      "label": "Discount Text Color",
      "default": "#666666"
    }
  ],
  "presets": [
    {
      "name": "Savings Display"
    }
  ]
}
{% endschema %}