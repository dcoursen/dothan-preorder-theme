{% comment %}
  Simple Savings Display Block
  Shows savings text from product or variant metafields
{% endcomment %}

{% assign v = product.selected_or_first_available_variant %}
{% assign product_text = product.metafields.custom.quantity_discount_text %}

<div id="savings-display-{{ section.id }}" class="savings-display-block" 
     data-section-id="{{ section.id }}"
     style="{% if product_text != blank %}display: block;{% elsif v and v.metafields.custom.variant_only_discount_text != blank %}display: block;{% else %}display: none;{% endif %}">
  
  <div class="savings-display-content" style="
    display: flex;
    align-items: center;
    gap: 8px;
    background: {{ block.settings.background_color | default: '#e8f5e8' }};
    border: 1px solid {{ block.settings.border_color | default: '#28a745' }};
    border-radius: 4px;
    padding: 10px 12px;
    font-size: 14px;
    margin: 8px 0;
  ">
    
    <!-- Tag Icon (diamond shaped like sample) -->
    <div style="
      background: {{ block.settings.icon_background_color | default: '#28a745' }};
      border-radius: 3px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 24px;
      transform: rotate(45deg);
    ">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="white" style="transform: rotate(-45deg);">
        <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V21C3,22.11 3.89,23 5,23H19C20.11,23 21,22.11 21,21V9M19,9H14V4H19V9Z"/>
      </svg>
    </div>

    <!-- Single Line Text Content -->
    <span style="
      color: {{ block.settings.text_color | default: '#333' }};
      font-weight: {{ block.settings.label_font_weight | default: '600' }};
      {% case block.settings.text_transform %}
        {% when 'uppercase' %}text-transform: uppercase;
        {% when 'lowercase' %}text-transform: lowercase;
        {% when 'capitalize' %}text-transform: capitalize;
      {% endcase %}
    ">
      {{ block.settings.label_text | default: 'Bulk Savings' }}
    </span>
    
    <span id="discount-text-{{ section.id }}" 
          data-product-text="{{ product_text }}" 
          style="
            color: {{ block.settings.discount_text_color | default: '#666' }};
            font-weight: {{ block.settings.discount_font_weight | default: '400' }};
            margin-left: 4px;
          ">
      {% if v and v.metafields.custom.variant_only_discount_text != blank %}
        {{ v.metafields.custom.variant_only_discount_text }}
      {% elsif product_text != blank %}
        {{ product_text }}
      {% endif %}
    </span>
  </div>
</div>

<script>
(function() {
  var SECTION_ID = "{{ section.id }}";
  var container = document.getElementById("savings-display-" + SECTION_ID);
  var discountText = document.getElementById("discount-text-" + SECTION_ID);
  
  if (!container || !discountText) return;

  var productText = discountText.getAttribute('data-product-text') || '';

  // Map variant IDs to their discount text
  var variantText = {
    {% for variant in product.variants %}
      "{{ variant.id }}": {{ variant.metafields.custom.variant_only_discount_text | default: '' | json }},
    {% endfor %}
  };

  // Get current variant ID
  function getCurrentVariantId() {
    var params = new URLSearchParams(location.search);
    var fromUrl = params.get('variant');
    if (fromUrl) return fromUrl;

    var select = document.querySelector('select[name="id"]');
    if (select && select.value) return select.value;

    var radio = document.querySelector('input[name="id"]:checked');
    if (radio && radio.value) return radio.value;

    var hidden = document.querySelector('input[type="hidden"][name="id"]');
    if (hidden && hidden.value) return hidden.value;

    return "{{ v.id }}";
  }

  // Update display
  function updateDisplay(variantId) {
    var text = variantText[String(variantId)] || productText;
    
    if (text && text.trim()) {
      discountText.textContent = text;
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }

  // Listen for variant changes
  document.addEventListener('variant:change', function(e){
    var id = e?.detail?.variant?.id;
    if (id) updateDisplay(id);
  });

  document.addEventListener('change', function(e){
    if (e.target && e.target.name === 'id') {
      updateDisplay(getCurrentVariantId());
    }
  });

  // Initial display
  updateDisplay(getCurrentVariantId());
})();
</script>

{% schema %}
{
  "name": "Savings Display",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "Simple display for bulk savings messages. Reads from 'quantity_discount_text' (product) or 'variant_only_discount_text' (variant) metafields."
    },
    {
      "type": "text",
      "id": "label_text",
      "label": "Label Text",
      "default": "Bulk Savings",
      "info": "Text shown before the discount message"
    },
    {
      "type": "select",
      "id": "text_transform",
      "label": "Label Text Case",
      "options": [
        { "value": "none", "label": "Normal" },
        { "value": "uppercase", "label": "UPPERCASE" },
        { "value": "lowercase", "label": "lowercase" },
        { "value": "capitalize", "label": "Capitalize" }
      ],
      "default": "none"
    },
    {
      "type": "select",
      "id": "label_font_weight",
      "label": "Label Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "600"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#e8f5e8"
    },
    {
      "type": "color",
      "id": "border_color", 
      "label": "Border Color",
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "icon_background_color",
      "label": "Icon Background Color", 
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "discount_text_color",
      "label": "Discount Text Color",
      "default": "#666666"
    },
    {
      "type": "select",
      "id": "discount_font_weight",
      "label": "Discount Text Font Weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" }
      ],
      "default": "400"
    }
  ],
  "presets": [
    {
      "name": "Savings Display"
    }
  ]
}
{% endschema %}