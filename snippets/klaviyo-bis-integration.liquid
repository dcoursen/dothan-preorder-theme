{%- comment -%}
  Simple and Reliable Preorder + BIS Integration
{%- endcomment -%}

{%- liquid
  assign target_product = product
  assign target_variant = product.selected_or_first_available_variant
  assign inventory_quantity = target_variant.inventory_quantity
  assign product_available = target_product.available
  assign today = 'now' | date: '%s'
  assign drop_date_field = target_product.metafields.custom.preorder_drop_date
  
  # Force enable for testing (remove these when theme settings work)
  assign bis_enabled = true
  assign preorder_enabled = true
  assign klaviyo_form_id = 'TEST123'
  
  assign show_preorder_date = false
  assign show_klaviyo_button = false
  assign preorder_text = ''
  assign klaviyo_button_text = ''
  assign has_future_preorder = false
  
  # Check for future preorder date
  if drop_date_field != blank
    assign drop_date = drop_date_field | date: '%s'
    assign days_until_drop = drop_date | minus: today | divided_by: 86400
    
    if days_until_drop > 0
      assign has_future_preorder = true
      assign show_preorder_date = true
      assign formatted_date = drop_date_field | date: '%B %d @ %l:%M%p EST'
      assign preorder_text = 'Available ' | append: formatted_date
    endif
  endif
  
  # Determine Klaviyo button logic
  if inventory_quantity < 1 and product_available == false
    assign show_klaviyo_button = true
    
    if has_future_preorder
      assign klaviyo_button_text = 'Get Early Access'
    else
      assign klaviyo_button_text = 'Notify When Back in Stock'
    endif
  endif
-%}

{%- comment -%}Always show preorder date if it exists{%- endcomment -%}
{%- if show_preorder_date -%}
  <div style="background: #e8f5e8; border: 2px solid #4a7c4a; padding: 12px; margin: 0 0 15px 0; text-align: center; border-radius: 8px; font-weight: 600;">
    {{ preorder_text }}
  </div>
{%- endif -%}

{%- comment -%}Only show Klaviyo button for sold-out products{%- endcomment -%}
{%- if show_klaviyo_button -%}
  <div style="margin: 15px 0;">
    <button type="button" 
            onclick="alert('Klaviyo form would open here with: {{ klaviyo_button_text }}')"
            style="width: 100%; padding: 15px; background: #dc6565; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
      {{ klaviyo_button_text }}
    </button>
  </div>
{%- endif -%}

{%- comment -%}DEBUG INFO{%- endcomment -%}
<div style="font-size: 11px; color: #666; margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 4px;">
  <strong>DEBUG:</strong> Product={{ target_product.title | truncate: 20 }}, 
  Inventory={{ inventory_quantity }}, 
  Available={{ product_available }}, 
  Drop Date={{ drop_date_field | date: '%m/%d' | default: 'none' }}, 
  Show Date={{ show_preorder_date }}, 
  Show Button={{ show_klaviyo_button }}
</div>
