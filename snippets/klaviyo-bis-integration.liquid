{%- comment -%}
  JavaScript-based Preorder + BIS Integration
  This works WITH your theme's existing logic instead of fighting it
{%- endcomment -%}

{%- liquid
  assign target_product = product
  assign target_variant = product.selected_or_first_available_variant
  assign inventory_quantity = target_variant.inventory_quantity
  assign product_available = target_product.available
  assign today = 'now' | date: '%s'
  assign drop_date_field = target_product.metafields.custom.preorder_drop_date
  
  assign has_future_preorder = false
  assign preorder_text = ''
  assign klaviyo_button_text = ''
  
  # Check for future preorder date
  if drop_date_field != blank
    assign drop_date = drop_date_field | date: '%s'
    assign days_until_drop = drop_date | minus: today | divided_by: 86400
    
    if days_until_drop > 0
      assign has_future_preorder = true
      assign formatted_date = drop_date_field | date: '%B %d @ %l:%M%p EST'
      assign preorder_text = 'Available ' | append: formatted_date
    endif
  endif
  
  # Determine button text for sold-out products
  if inventory_quantity < 1 and product_available == false
    if has_future_preorder
      assign klaviyo_button_text = 'Get Early Access'
    else
      assign klaviyo_button_text = 'Notify When Back in Stock'
    endif
  endif
-%}

{%- comment -%}
  This div will be populated by JavaScript after your theme loads
{%- endcomment -%}
<div id="preorder-bis-container" 
     data-product-id="{{ target_product.id }}"
     data-has-preorder="{{ has_future_preorder }}"
     data-preorder-text="{{ preorder_text | escape }}"
     data-inventory="{{ inventory_quantity }}"
     data-available="{{ product_available }}"
     data-klaviyo-text="{{ klaviyo_button_text | escape }}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Wait a bit for your theme's logic to finish
  setTimeout(function() {
    initializePreorderBIS();
  }, 500);
  
  function initializePreorderBIS() {
    const container = document.getElementById('preorder-bis-container');
    if (!container) return;
    
    const hasPreorder = container.dataset.hasPreorder === 'true';
    const preorderText = container.dataset.preorderText;
    const inventory = parseInt(container.dataset.inventory);
    const available = container.dataset.available === 'true';
    const klaviyoText = container.dataset.klaviyoText;
    
    console.log('Preorder BIS Debug:', {
      hasPreorder,
      preorderText,
      inventory,
      available,
      klaviyoText
    });
    
    // Always show preorder date if it exists
    if (hasPreorder && preorderText) {
      showPreorderDate(container, preorderText);
    }
    
    // Handle sold-out products
    if (inventory < 1 && !available) {
      // Wait a bit more for add-to-cart component to settle
      setTimeout(function() {
        replaceSoldOutButton(container, klaviyoText);
      }, 200);
    }
  }
  
  function showPreorderDate(container, text) {
    const dateDiv = document.createElement('div');
    dateDiv.innerHTML = `
      <div style="background: #e8f5e8; border: 2px solid #4a7c4a; padding: 12px; margin: 0 0 15px 0; text-align: center; border-radius: 8px; font-weight: 600;">
        ${text}
      </div>
    `;
    container.appendChild(dateDiv);
  }
  
  function replaceSoldOutButton(container, buttonText) {
    // Find the add-to-cart component
    const addToCartComponent = document.querySelector('add-to-cart-component');
    const addToCartButton = document.querySelector('[name="add"]');
    
    if (addToCartComponent && buttonText) {
      // Hide the original add to cart
      addToCartComponent.style.display = 'none';
      
      // Create and show our BIS button
      const bisDiv = document.createElement('div');
      bisDiv.innerHTML = `
        <button type="button" 
                onclick="alert('Klaviyo form: ${buttonText}')"
                style="width: 100%; padding: 15px; background: #dc6565; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
          ${buttonText}
        </button>
      `;
      container.appendChild(bisDiv);
    }
  }
});
</script>

{%- comment -%}DEBUG INFO{%- endcomment -%}
<div style="font-size: 11px; color: #666; margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 4px;">
  <strong>DEBUG:</strong> 
  Product={{ target_product.title | truncate: 15 }}, 
  Future Preorder={{ has_future_preorder }}, 
  Inventory={{ inventory_quantity }}, 
  Available={{ product_available }}
  {%- if drop_date_field -%}, Drop Date={{ drop_date_field | date: '%m/%d %H:%M' }}{%- endif -%}
</div>
