{% comment %}
  Enhanced Preorder Logic with Klaviyo Back in Stock Integration
  
  Handles:
  - Available products (normal add to cart)
  - Preorder products with future drop dates
  - Preorder products with past drop dates (back in stock)
  - Regular sold-out products (back in stock)
  - Fallback sold-out state
{% endcomment %}

{% assign current_variant = variant | default: product.selected_or_first_available_variant %}

{% if product.available %}
  {% comment %} Product is available - show normal add to cart {% endcomment %}
  <div class="product-form__buttons">
    <button
      type="submit"
      name="add"
      class="btn product-form__cart-submit{% if block.settings.show_dynamic_checkout and product.selling_plan_groups == empty %} btn--secondary-accent{% endif %}"
      {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
    >
      <span>
        {%- if product.selected_or_first_available_variant.available -%}
          {{ 'products.product.add_to_cart' | t }}
        {%- else -%}
          {{ 'products.product.sold_out' | t }}
        {%- endif -%}
      </span>
      <div class="loading-overlay__spinner hidden">
        <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
          <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
        </svg>
      </div>
    </button>
  </div>

{% elsif product.metafields.custom.preorder_enabled %}
  {% comment %} Preorder product - check drop date {% endcomment %}
  {% assign drop_date = product.metafields.custom.preorder_drop_date | date: '%s' | plus: 0 %}
  {% assign current_date = 'now' | date: '%s' | plus: 0 %}
  
  {% if drop_date > current_date %}
    {% comment %} Future drop date - check for Klaviyo override {% endcomment %}
    {% if settings.klaviyo_back_in_stock_enabled and settings.klaviyo_preorder_back_in_stock_override != blank %}
      {% render 'klaviyo-back-in-stock', 
         product: product, 
         variant: current_variant,
         button_text: settings.klaviyo_preorder_back_in_stock_override,
         context: 'preorder-override' %}
    {% else %}
      {% comment %} Show preorder button {% endcomment %}
      <div class="product-form__buttons">
        <button
          type="submit"
          name="add"
          class="btn product-form__cart-submit btn--preorder"
          data-preorder="true"
        >
          <span>{{ 'products.product.preorder' | t | default: 'Pre-order' }}</span>
        </button>
      </div>
    {% endif %}
    
  {% else %}
    {% comment %} Drop date passed, inventory 0 - use back in stock {% endcomment %}
    {% if settings.klaviyo_back_in_stock_enabled %}
      {% render 'klaviyo-back-in-stock', 
         product: product, 
         variant: current_variant,
         button_text: settings.klaviyo_back_in_stock_button_text,
         context: 'post-preorder' %}
    {% else %}
      <div class="product-form__buttons">
        <button type="button" class="btn product-form__cart-submit" disabled>
          <span>{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
        </button>
      </div>
    {% endif %}
  {% endif %}

{% elsif settings.klaviyo_back_in_stock_enabled %}
  {% comment %} Regular sold-out product with Klaviyo enabled {% endcomment %}
  {% render 'klaviyo-back-in-stock', 
     product: product, 
     variant: current_variant,
     context: 'sold-out' %}

{% else %}
  {% comment %} Default sold-out state {% endcomment %}
  <div class="product-form__buttons">
    <button type="button" class="btn product-form__cart-submit" disabled>
      <span>{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
    </button>
  </div>
{% endif %}