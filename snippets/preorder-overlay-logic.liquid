{%- liquid
  assign today = 'now' | date: '%s'
  assign drop_date_field = product.metafields.custom.preorder_drop_date
  
  # Initialize preorder variables globally
  assign preorder_is_preorder = false
  assign preorder_text = ''
  assign preorder_is_coming_soon = false
  assign preorder_smart_drop_date = ''
  
  if drop_date_field != blank
    assign drop_date = drop_date_field | date: '%s'
    assign days_until_drop = drop_date | minus: today | divided_by: 86400
    assign drop_weekday = drop_date_field | date: '%w'
    
    if days_until_drop > 0
      assign preorder_is_preorder = true
      assign preorder_is_coming_soon = true
      
      # Get day name
      case drop_weekday
        when '0'
          assign day_name = 'Sunday'
        when '1'
          assign day_name = 'Monday'
        when '2'
          assign day_name = 'Tuesday'
        when '3'
          assign day_name = 'Wednesday'
        when '4'
          assign day_name = 'Thursday'
        when '5'
          assign day_name = 'Friday'
        when '6'
          assign day_name = 'Saturday'
      endcase
      
      if days_until_drop <= 7
        assign time_with_tz = drop_date_field | date: '%l:%M%p EST'
        assign preorder_text = 'This ' | append: day_name | append: ' @ ' | append: time_with_tz
        assign preorder_smart_drop_date = preorder_text
      else
        assign formatted_date = drop_date_field | date: '%-m/%-d'
        assign preorder_text = day_name | append: ' ' | append: formatted_date
        assign preorder_smart_drop_date = preorder_text
      endif
    endif
  endif
-%}
